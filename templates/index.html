<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prompt Assist UI</title>
  <style>
    /* --- your existing styles kept as-is --- */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.8s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}
    }
    .container{background:rgba(255,255,255,.95);backdrop-filter:blur(15px);border-radius:24px;padding:40px;box-shadow:0 25px 50px rgba(0,0,0,.15),0 0 0 1px rgba(255,255,255,.3);width:100%;max-width:600px;border:1px solid rgba(255,255,255,.2);animation:slideUp 0.6s ease-out 0.2s both}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    h2{color:#2d3748;font-size:2.2rem;font-weight:700;text-align:center;margin-bottom:35px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 2px 4px rgba(0,0,0,0.1);letter-spacing:-0.5px}
    .input-group{margin-bottom:30px}
    textarea{width:100%;height:130px;padding:18px;border:2px solid #e2e8f0;border-radius:16px;font-size:16px;background:#f8fafc;color:#2d3748;resize:vertical;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);box-shadow:0 4px 12px rgba(0,0,0,0.05);line-height:1.6}
    textarea:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 8px 25px rgba(102,126,234,0.2);transform:translateY(-2px)}
    textarea::placeholder{color:#a0aec0;font-style:italic}
    .controls{display:flex;gap:18px;align-items:center;margin-bottom:30px;flex-wrap:wrap}
    select,button{padding:14px 20px;border:2px solid #e2e8f0;border-radius:12px;font-size:16px;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);font-weight:500}
    select{background:#f8fafc;color:#2d3748;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    select:focus{outline:none;border-color:#667eea;box-shadow:0 4px 15px rgba(102,126,234,0.15)}
    button{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:600;box-shadow:0 6px 20px rgba(102,126,234,.25);border:none;position:relative;overflow:hidden}
    button::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s}
    button:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(102,126,234,.4)}
    button:hover::before{left:100%}
    button:active{transform:translateY(-1px)}
    h3{color:#2d3748;font-size:1.4rem;font-weight:600;margin-bottom:18px;position:relative;padding-left:8px}
    h3::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:2px}
    pre{background:linear-gradient(135deg,#f8fafc,#e2e8f0);padding:24px;border-radius:16px;border:1px solid #e2e8f0;font-family:'Courier New',monospace;white-space:pre-wrap;box-shadow:0 4px 12px rgba(0,0,0,0.05);line-height:1.6;position:relative}
    pre::before{content:'';position:absolute;top:12px;left:12px;width:12px;height:12px;background:#ff6b6b;border-radius:50%;box-shadow:20px 0 0 #feca57,40px 0 0 #48dbfb}
    .loading{display:none;text-align:center;color:#667eea;font-style:italic;margin:25px 0;padding:20px;background:rgba(102,126,234,0.1);border-radius:12px;border:2px dashed #667eea}
    .loading::before{content:'‚è≥';margin-right:8px;animation:spin 2s linear infinite}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    .row{display:flex;gap:12px;margin:15px 0;align-items:center}
    .row button{flex:0 0 auto;font-size:14px;padding:10px 16px}
    .row .spacer{flex:1 1 auto}
    .clarify-input{margin-top:15px}
    .clarify-input label{display:block;margin-bottom:8px;color:#4a5568;font-weight:500;font-size:14px}
    .clarify-input input{width:100%;padding:12px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;background:#f8fafc;color:#2d3748;transition:all 0.3s ease;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
    .clarify-input input:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 4px 15px rgba(102,126,234,0.15)}
    @media (max-width: 640px) {
      .container{padding:25px;margin:10px}
      h2{font-size:1.8rem}
      .controls{flex-direction:column;align-items:stretch}
      .controls select,.controls button{width:100%}
      .row{flex-direction:column;gap:8px}
      .row button{width:100%}
    }
    .input-group:hover textarea{border-color:#cbd5e0}
    button:disabled{opacity:0.6;cursor:not-allowed;transform:none !important}
    button:disabled:hover{box-shadow:0 6px 20px rgba(102,126,234,.25) !important}
    form{animation:slideIn 0.4s ease-out}
    @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
  </style>
</head>
<body>
  <div class="container">
    <h2>Prompt Assist Demo</h2>

    <div class="input-group">
      <textarea id="userText" placeholder="Type your prompt here... ‚ú®"></textarea>
    </div>

    <div class="controls">
      <button id="getBtn">‚ú® Get Suggestions</button>
    </div>

    <div class="loading" id="loading">Processing your request...</div>

    <h3>Response:</h3>
    <pre id="output">Your suggestions will appear here...</pre>

    <div class="row">
      <button id="copyBtn" disabled>üìã Copy</button>
      <button id="altBtn" disabled>üîÅ Alternate</button>
      <div class="spacer"></div>
    </div>

    <!-- Clarifying questions form placeholder (rendered dynamically) -->
    <form id="clarifyForm" onsubmit="submitAnswers(event)">
      <h3>‚ùì Clarifying Questions:</h3>
      <div id="clarifyFields"></div>
      <button id="clarifySubmit" type="submit" style="margin-top:20px;background:linear-gradient(135deg,#48bb78,#38a169)">üöÄ Submit Answers</button>
    </form>
  </div>

  <script>
    // ---------- Globals / State ----------
    let LAST_SUGGEST = null;
    let LAST_REFINED_PROMPT = "";
    let LAST_INTENT = "";
    let LAST_ANSWERS = [];
    let ALT_CLICK_COUNT = 0;

    const OUTPUT    = document.getElementById("output");
    const LOADING   = document.getElementById("loading");
    const GET_BTN   = document.getElementById("getBtn");
    const ALT_BTN   = document.getElementById("altBtn");
    const COPY_BTN  = document.getElementById("copyBtn");
    const FORM      = document.getElementById("clarifyForm");
    const FIELDS    = document.getElementById("clarifyFields");

    // ---------- Helpers ----------
    function setLoading(isLoading, text = "Processing your request...") {
      LOADING.style.display = isLoading ? "block" : "none";
      if (isLoading) LOADING.textContent = text;
    }

    function renderQuestions(intent, questions) {
      const supported = ["image", "email", "code"];
      if (!supported.includes(intent)) {
        FORM.style.display = "none";
        FIELDS.innerHTML = "";
        return;
      }

      FIELDS.innerHTML = "";
      (questions || []).forEach((q, i) => {
        const wrap = document.createElement("div");
        wrap.className = "clarify-input";
        const label = document.createElement("label");
        label.textContent = q;
        const input = document.createElement("input");
        input.type = "text";
        input.name = `q${i+1}`;
        wrap.appendChild(label);
        wrap.appendChild(input);
        FIELDS.appendChild(wrap);
      });

      FORM.style.display = questions && questions.length ? "block" : "none";
    }

    function showFirstPass(data) {
      let html = `‚ú® Improved Prompt:\n${data.improved_prompt || "N/A"}\n\n`;
      if (data.clarifying_questions?.length) {
        html += "‚ùì Clarifying Questions:\n";
        data.clarifying_questions.forEach((q, i) => html += `${i+1}. ${q}\n`);
      }
      OUTPUT.textContent = html;
    }

    function getAnswersFromForm() {
      const fd = new FormData(FORM);
      const out = [];
      for (const [name, value] of fd.entries()) {
        out.push({ name, value: String(value || "").trim() });
      }
      return out;
    }

    function enableAltCopy(enabled) {
      ALT_BTN.disabled  = !enabled;
      COPY_BTN.disabled = !enabled;
    }

    // ---------- Actions ----------
    async function sendRequest() {
      const text = document.getElementById("userText").value;
      const lang = "en"; // single language

      // Reset state for a new session
      LAST_SUGGEST = null;
      LAST_REFINED_PROMPT = "";
      LAST_INTENT = "";
      LAST_ANSWERS = [];
      ALT_CLICK_COUNT = 0;
      enableAltCopy(false);

      setLoading(true, "Analyzing prompt‚Ä¶");
      OUTPUT.textContent = "Processing‚Ä¶";
      FORM.style.display = "none";
      FIELDS.innerHTML = "";

      try {
        const res = await fetch("/api/suggest", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, lang })
        });

        const ct = res.headers.get("content-type") || "";
        if (!ct.includes("application/json")) {
          const txt = await res.text();
          throw new Error(`Server did not return JSON. ${txt.slice(0, 200)}‚Ä¶`);
        }

        const data = await res.json();
        LAST_SUGGEST = data;
        LAST_INTENT = data.intent || "";

        if (!["image","email","code"].includes(LAST_INTENT)) {
          LAST_INTENT = "general";
        }

        showFirstPass(data);
        renderQuestions(LAST_INTENT, data.clarifying_questions || []);

      } catch (err) {
        OUTPUT.textContent = "Error: " + (err?.message || err);
      } finally {
        setLoading(false);
      }
    }

    async function submitAnswers(ev) {
      ev.preventDefault();
      const text = document.getElementById("userText").value;
      const lang = "en";

      const answers = getAnswersFromForm().filter(a => a.value);
      LAST_ANSWERS = answers;

      setLoading(true, "Refining prompt‚Ä¶");
      OUTPUT.textContent = "Refining‚Ä¶";

      try {
        const res = await fetch("/api/refine", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text,
            lang,
            intent: LAST_INTENT,
            answers
          })
        });

        const ct = res.headers.get("content-type") || "";
        if (!ct.includes("application/json")) {
          const txt = await res.text();
          throw new Error(`Server did not return JSON. ${txt.slice(0, 200)}‚Ä¶`);
        }

        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);

        LAST_REFINED_PROMPT = data.refined_prompt || "";
        LAST_INTENT = data.intent || LAST_INTENT;

        if (!LAST_REFINED_PROMPT) {
          OUTPUT.textContent = "No refined prompt generated.";
          enableAltCopy(false);
          return;
        }

        OUTPUT.textContent = `üéØ Refined Prompt:\n${LAST_REFINED_PROMPT}`;
        ALT_CLICK_COUNT = 0;
        enableAltCopy(true);
      } catch (err) {
        OUTPUT.textContent = "Error: " + (err?.message || err);
        enableAltCopy(false);
      } finally {
        setLoading(false);
      }
    }

    async function onAlternateClick() {
      if (!LAST_REFINED_PROMPT || !LAST_INTENT) {
        OUTPUT.textContent = "No refined prompt available yet. Submit answers first.";
        return;
      }
      ALT_BTN.disabled = true;
      setLoading(true, "Generating alternate‚Ä¶");
      OUTPUT.textContent = "Generating alternate‚Ä¶";

      try {
        const res = await fetch("/api/alternate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prompt: LAST_REFINED_PROMPT,
            intent: LAST_INTENT,
            answers: LAST_ANSWERS || [],
            index: ALT_CLICK_COUNT || 0
          })
        });

        const ct = res.headers.get("content-type") || "";
        if (!ct.includes("application/json")) {
          const txt = await res.text();
          throw new Error(`Server did not return JSON. ${txt.slice(0, 200)}‚Ä¶`);
        }

        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);

        const alt = data.alternate_prompt || "";
        if (!alt.trim()) {
          throw new Error("No alternate generated.");
        }

        LAST_REFINED_PROMPT = alt;
        ALT_CLICK_COUNT = (ALT_CLICK_COUNT || 0) + 1;

        OUTPUT.textContent = `üéØ Refined Prompt:\n${LAST_REFINED_PROMPT}`;
      } catch (err) {
        OUTPUT.textContent = "Error: " + (err?.message || err);
      } finally {
        setLoading(false);
        ALT_BTN.disabled = false;
      }
    }

    async function onCopyClick() {
      const toCopy = LAST_REFINED_PROMPT || "";
      if (!toCopy.trim()) return;
      try {
        await navigator.clipboard.writeText(toCopy);
        COPY_BTN.textContent = "‚úÖ Copied";
        setTimeout(() => (COPY_BTN.textContent = "üìã Copy"), 1200);
      } catch (e) {
        COPY_BTN.textContent = "‚ùå Copy failed";
        setTimeout(() => (COPY_BTN.textContent = "üìã Copy"), 1200);
      }
    }

    // ---------- Event bindings ----------
    GET_BTN.addEventListener("click", sendRequest);
    document.getElementById("clarifyForm").addEventListener("submit", submitAnswers);
    ALT_BTN.addEventListener("click", onAlternateClick);
    COPY_BTN.addEventListener("click", onCopyClick);
  </script>
</body>
</html>
